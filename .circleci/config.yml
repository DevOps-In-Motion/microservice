version: 2.1

orbs:
  aws-cli: circleci/aws-cli@5.4.1

# No top-level parameters block is needed for this config; removing for CircleCI best practice.

jobs:
  unit-test:
  
    docker:
      - image: cimg/python:3.10
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: run tests
          command: |
            mkdir -p test-results
            pip install -r requirements.txt
            pytest app/tests/test_mock_integration.py --junitxml=test-results/junit-mock-integration.xml
            pytest app/tests/test_main.py --junitxml=test-results/junit-main-py.xml
      - store_test_results:
          path: test-results
      - persist_to_workspace:
          root: .
          paths:
            - test-results

  db-test:
    docker:
      # - image: cimg/python:3.10 # change to image with tag
      #  environment:
      #    TEST_DATABASE_URL: postgresql://postgres@localhost/circle_test
      
      # Sidecar container image
      - image: cimg/base:2026.02

    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - attach_workspace:
          at: .
      - run:
          name: Build images
          command: |
            docker-compose build --no-cache api
            docker-compose build test
      - run:
          name: Start & Wait for containers to be ready
          command: |
            docker-compose up -d
            docker-compose ps
            # Wait for db to be healthy (already has healthcheck)
            until docker-compose exec -T db pg_isready -U postgres; do
              echo "Waiting for db..."
              sleep 2
            done
            # Wait for api to respond
            count=0
            max_tries=3
            # Wait until the API container status is "running"
            until docker-compose ps api | grep -qE "(Up|Running)"; do
              count=$((count + 1))
              if [ $count -ge $max_tries ]; then
                echo "API did not become ready after $max_tries tries. Exiting."
                docker-compose ps api
                docker-compose logs api --tail=20
                exit 1
              fi
              echo "Waiting for api... ($count/$max_tries)"
              sleep 2
            done
            echo "API container is running!"
            echo "Both containers are ready!"
      - run: 
          name: Wait for DB
          command: docker-compose exec -T db pg_isready -U postgres  # wait for ready
      - run: 
          name: Install pSQL client
          command: sudo apt-get update && sudo apt-get install -y postgresql-client
      - run: 
          name: Set Seed Data
          command: chmod +x ./.circleci/sh/seed-data.sh && ./.circleci/sh/seed-data.sh
      - run:
          name: Run Integration Tests 
          command: |
            pwd 
            ls -a
            # this works!
            docker-compose exec -T api pytest tests/test_integration.py -v --tb=short
            # docker-compose run --rm test
      - store_test_results:
          path: test-results

  build:
    docker:
      - image: cimg/base:2026.02
    steps:
      - checkout
      - attach_workspace:
          at: .
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Set TAG variable
          command: |
              echo "export TAG=circleci_0.1.${CIRCLE_BUILD_NUM}" >> $BASH_ENV
      - run:
          name: Build Docker image
          command: |
            TAG=circleci_0.1.${CIRCLE_BUILD_NUM}
            mkdir -p images
            echo $TAG > images/tag.txt
            docker image build -t devopsinmotion/circleci:$TAG .
      - run:
          name: Smoke Test New Image
          command: |
            set -e
            NET=smoke-net
            docker network create $NET || true
            docker run -d --name smoke-db --network $NET -e POSTGRES_PASSWORD=postgres postgres:15-alpine
            until docker run --rm --network $NET postgres:15-alpine pg_isready -h smoke-db -U postgres; do
              echo "Waiting for postgres..."; sleep 2;
            done
            docker run -d --name smoke-api --network $NET \
              -e DATABASE_URL=postgresql://postgres:postgres@smoke-db:5432/postgres \
              devopsinmotion/circleci:$TAG
            for i in $(seq 1 3); do
              if docker run --rm --network $NET curlimages/curl:latest curl -sf http://smoke-api:8000/health > /dev/null; then break; fi
              if [ $i -eq 3 ]; then echo "API did not become ready"; docker logs smoke-api; exit 1; fi
              echo "Waiting for API... ($i/3)"; sleep 2;
            done
            docker run --rm --network $NET curlimages/curl:latest curl -sf http://smoke-api:8000/health
            docker stop smoke-api smoke-db
            docker rm smoke-api smoke-db
            docker network rm $NET
      - run:
          name: Save image as tar
          command: |
            docker image save -o "images/${TAG}.tar" "devopsinmotion/circleci:${TAG}"
      - persist_to_workspace:
          root: .
          paths:
            - images

  push:
    environment:
      AWS_REGION: us-west-2
      ROLE_ARN: "arn:aws:iam::588738600522:role/CircleCI-ECRAccess"
    docker:
      - image: cimg/aws:2025.01
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Debug - Check workspace contents
          command: |
            pwd
            ls -la
            ls -la images/ || echo "images directory not found"
            cat images/tag.txt
      - run:
          name: Load TAG from file
          command: |
            echo "export TAG=$(cat images/tag.txt)" >> $BASH_ENV
      - setup_remote_docker:
          docker_layer_caching: true
      - aws-cli/setup:
          role_arn: ${ROLE_ARN}
          region: ${AWS_REGION}
          role_session_name: "ECR-push-build"
          session_duration: "1800"
      - run:
          name: Log-into-AWS-ECR
          command: |
            aws ecr get-login-password --region=us-east-1 | docker login --username AWS --password-stdin 588738600522.dkr.ecr.us-east-1.amazonaws.com
      - run:
          name: Load image | Inspect | Push 
          command: |
            echo $TAG
            docker image load -i "images/${TAG}.tar"
            docker image ls
            docker tag devopsinmotion/circleci:$TAG 588738600522.dkr.ecr.us-east-1.amazonaws.com/devopsinmotion/circleci:$TAG
            docker push 588738600522.dkr.ecr.us-east-1.amazonaws.com/devopsinmotion/circleci:${TAG}


workflows:
  testBuildPush:
    filters:
      branches:
        only:
          - main
    jobs:
      - unit-test
      - db-test:
          requires:
            - unit-test:
              - success
      - build:
          requires:
            - db-test:
              - success
      - push:
          requires:
            - build

