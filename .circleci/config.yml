version: 2.1

orbs:
  aws-cli: circleci/aws-cli@5.4.1

# No top-level parameters block is needed for this config; removing for CircleCI best practice.

jobs:
  unit-test:
  
    docker:
      - image: cimg/python:3.10
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: run tests
          command: |
            mkdir -p test-results
            pip install -r requirements.txt
            pytest app/tests/test_mock_integration.py --junitxml=test-results/junit-mock-integration.xml
            pytest app/tests/test_main.py --junitxml=test-results/junit-mock-integration.xml
      - store_test_results:
          path: test-results
      - persist_to_workspace:
          root: .
          paths:
            - test-results

  db-test:
    docker:
      # - image: cimg/python:3.10 # change to image with tag
      #  environment:
      #    TEST_DATABASE_URL: postgresql://postgres@localhost/circle_test
      
      # Sidecar container image
      - image: cimg/base:2026.02

    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - attach_workspace:
          at: .
      - run:
          name: Build images
          command: |
            docker-compose build --no-cache api
            docker-compose build test
      - run:
          name: Start services
          command: docker-compose up -d
      - run:
          name: Wait for containers to be ready
          command: |
            docker-compose up -d
            docker-compose ps
            # Wait for db to be healthy (already has healthcheck)
            until docker-compose exec -T db pg_isready -U postgres; do
              echo "Waiting for db..."
              sleep 2
            done
            # Wait for api to respond
            count=0
            max_tries=3
            # Wait until the API container status is "running"
            until docker-compose ps api | grep -qE "(Up|Running)"; do
              count=$((count + 1))
              if [ $count -ge $max_tries ]; then
                echo "API did not become ready after $max_tries tries. Exiting."
                docker-compose ps api
                docker-compose logs api --tail=20
                exit 1
              fi
              echo "Waiting for api... ($count/$max_tries)"
              sleep 2
            done
            echo "API container is running!"
            echo "Both containers are ready!"
      - run: 
          name: Wait for DB
          command: docker-compose exec -T db pg_isready -U postgres  # wait for ready
      - run: 
          name: Install pSQL client
          command: sudo apt-get update && sudo apt-get install postgresql-client
      - run: 
          name: Set Seed Data
          command: chmod +x ./.circleci/sh/seed-data.sh && ./.circleci/sh/seed-data.sh
      - run:
          name: Run Integration Tests 
          command: |
            pwd 
            ls -a
            # this works!
            docker-compose exec -T api pytest tests/test_integration.py -v --tb=short
            # docker-compose run --rm test
      - store_test_results:
          path: test-results

  build:
    docker:
      - image: cimg/base:2026.02
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Build Docker image
          command: |
            TAG=0.1.$CIRCLE_BUILD_NUM
            docker image build -t devopsinmotion/circleci:circleci_$TAG .
      - run:
          name: Save image as tar
          command: |
            mkdir -p images
            docker image save -o "images/circleci_${TAG}.tar" "devopsinmotion/circleci:${TAG}"
      - persist_to_workspace:
          root: .
          paths:
            - images

  push:
    environment:
      AWS_REGION: us-west-2
      ROLE_ARN: "arn:aws:iam::588738600522:role/CircleCI-ECRAccess"
    docker:
      # - image: cimg/base:2026.02
      - image: cimg/aws:2025.01
    steps:
      - attach_workspace:
                at: .
      - setup_remote_docker:
          version: 20.10.18
      - aws-cli/setup:
          role_arn: ${ROLE_ARN}
          region: ${AWS_REGION}
          
          # optional parameters
          # profile_name: "OIDC-PROFILE"
          role_session_name: "ECR-push-build"
          session_duration: "1800"
      - run:
          name: Log-into-AWS-ECR
          command: |
            # must use same profile specified in the step above
            aws ecr get-login-password --region=us-east-1
            aws ecr get-login-password --region=us-east-1 | docker login --username AWS --password-stdin 588738600522.dkr.ecr.us-east-1.amazonaws.com
      - run:
          name: Load image
          command: |
            TAG=0.1.$CIRCLE_BUILD_NUM
            # repo name: 588738600522.dkr.ecr.us-east-1.amazonaws.com/devopsinmotion/circleci
            docker image load < "devopsinmotion/circleci:circleci_${TAG}"
            docker tag devopsinmotion/circleci:$TAG 588738600522.dkr.ecr.us-east-1.amazonaws.com/devopsinmotion/circleci:$TAG
      - run:
          name: Inspect loaded image
          command: |
            # we should see image listed
            docker image ls
      - run:
          name: Push application Docker image
          command: |
            TAG=0.1.$CIRCLE_BUILD_NUM
            docker push 588738600522.dkr.ecr.us-east-1.amazonaws.com/devopsinmotion/circleci:${TAG}
  cleanup:
    docker:
      - image: cimg/base:2026.02
    steps:
      - run: ./


workflows:
  testBuildPush:
    when: pipeline.git.branch == "main" or pipeline.git.branch == "staging"
    jobs:
      - unit-test
      - db-test:
          requires:
            - unit-test:
              - success
      - build:
          requires:
            - db-test:
              - success
      - push:
          requires:
            - build:
              - success
          filters:
            branches:
              only:
                - main
      - cleanup:
          requires:
            - push:
              - success
              - failed
              - canceled